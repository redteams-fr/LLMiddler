{% extends "base.html" %}
{% block title %}Sessions - gateway-ia{% endblock %}
{% block content %}
<div class="toolbar">
    <h1 id="session-count">Sessions ({{ sessions | length }})</h1>
    <div style="display: flex; align-items: center; gap: 16px;">
        <span id="token-totals" style="font-size: 11px; color: #8b949e;"></span>
        <form method="post" action="{{ ui_prefix }}/sessions/clear">
            <button class="btn btn-danger" type="submit"
                    onclick="return confirm('Clear all sessions?')">
                Clear
            </button>
        </form>
    </div>
</div>
<table>
    <thead>
        <tr>
            <th>Status</th>
            <th>Time</th>
            <th>Method</th>
            <th>Path</th>
            <th>Code</th>
            <th>Duration</th>
            <th>Type</th>
            <th>Tokens</th>
            <th></th>
        </tr>
    </thead>
    <tbody id="session-tbody">
        {% for s in sessions %}
        <tr data-id="{{ s.id }}" style="cursor:pointer">
            <td>
                <span class="badge badge-{{ s.status.value }}">
                    {{ s.status.value }}
                </span>
            </td>
            <td>{{ (s.created_at | localtime).strftime('%H:%M:%S') }}</td>
            <td><span class="badge badge-method">{{ s.method }}</span></td>
            <td>{{ s.path }}{% if s.query_string %}?{{ s.query_string }}{% endif %}</td>
            <td>
                {% if s.status_code %}
                <span class="
                    {% if s.status_code < 300 %}status-2xx
                    {% elif s.status_code < 500 %}status-4xx
                    {% else %}status-5xx{% endif %}
                ">{{ s.status_code }}</span>
                {% else %}-{% endif %}
            </td>
            <td>{{ s.duration_ms | format_duration if s.duration_ms is not none else '-' }}</td>
            <td>
                {% if s.is_streaming %}
                <span class="badge badge-streaming">stream</span>
                {% endif %}
            </td>
            <td>{% set tokens = s | usage_total %}{{ tokens if tokens else '-' }}</td>
            <td><a href="{{ ui_prefix }}/sessions/{{ s.id }}" class="btn-detail" title="Detail">&#x2197;</a></td>
        </tr>
        {% endfor %}
    </tbody>
</table>
<p id="empty-msg" style="color: #8b949e; text-align: center; padding: 40px; {% if sessions %}display:none{% endif %}">
    No sessions recorded. Send a request through the proxy to get started.
</p>

<div class="modal-overlay" id="modal-overlay">
    <div class="modal">
        <div class="modal-header">
            <span id="modal-title">Session</span>
            <button class="modal-close" id="modal-close">&times;</button>
        </div>
        <div class="modal-body" id="modal-body">
            <div id="panel-request">
                <div class="modal-panel-header">
                    <div class="modal-panel-title">Request</div>
                    <div>
                        <button class="btn-copy" id="btn-chat-request">Chat</button>
                        <button class="btn-copy" id="btn-tools-request">Tools</button>
                        <button class="btn-copy" id="btn-collapse-all" style="display:none">Collapse all</button>
                        <button class="btn-copy" data-target="modal-request">Copy</button>
                    </div>
                </div>
                <pre id="modal-request">-</pre>
                <div id="modal-request-chat" class="chat-container" style="display:none"></div>
                <div id="modal-request-tools" class="tools-container" style="display:none"></div>
            </div>
            <div id="panel-response">
                <div class="modal-panel-header">
                    <div class="modal-panel-title">Response</div>
                    <div>
                        <button class="btn-copy" data-target="modal-response">Copy</button>
                    </div>
                </div>
                <pre id="modal-response">-</pre>
            </div>
        </div>
    </div>
</div>

<script>
(function() {
    const UI_PREFIX = "{{ ui_prefix }}";
    const tbody = document.getElementById("session-tbody");
    const countEl = document.getElementById("session-count");
    const emptyMsg = document.getElementById("empty-msg");
    const overlay = document.getElementById("modal-overlay");
    const modalTitle = document.getElementById("modal-title");
    const modalRequest = document.getElementById("modal-request");
    const modalResponse = document.getElementById("modal-response");
    const modalRequestChat = document.getElementById("modal-request-chat");
    const btnChatRequest = document.getElementById("btn-chat-request");
    const btnToolsRequest = document.getElementById("btn-tools-request");
    const modalRequestTools = document.getElementById("modal-request-tools");
    const btnCollapseAll = document.getElementById("btn-collapse-all");
    const modalBody = document.getElementById("modal-body");
    const panelRequest = document.getElementById("panel-request");
    const panelResponse = document.getElementById("panel-response");
    const tokenTotalsEl = document.getElementById("token-totals");

    // Raw data stored for chat rendering
    let rawRequestBody = "";
    let rawResponseBody = "";
    // Current active view for request panel: "json" | "chat" | "tools"
    let requestView = "json";

    marked.setOptions({ breaks: true });

    function formatDuration(ms) {
        if (ms === null || ms === undefined) return "-";
        if (ms >= 1000) return (ms / 1000).toFixed(2) + " s";
        return ms.toFixed(1) + " ms";
    }

    function statusClass(code) {
        if (!code) return "";
        if (code < 300) return "status-2xx";
        if (code < 500) return "status-4xx";
        return "status-5xx";
    }

    function escapeHtml(text) {
        const d = document.createElement("div");
        d.textContent = text;
        return d.innerHTML;
    }

    function roleClass(role) {
        if (role === "user") return "chat-role-user";
        if (role === "assistant") return "chat-role-assistant";
        return "chat-role-system";
    }

    function truncate(text, len) {
        if (!text) return "";
        var plain = text.replace(/\n/g, " ").trim();
        return plain.length > len ? plain.substring(0, len) + "..." : plain;
    }

    function renderMessages(messages) {
        return messages.map(function(msg) {
            var preview = truncate(msg.content, 100);
            return '<div class="chat-message">' +
                '<span class="chat-collapse-indicator">&#x25BC;</span>' +
                '<div class="chat-role ' + roleClass(msg.role) + '">' + escapeHtml(msg.role) + '</div>' +
                '<span class="chat-preview">' + escapeHtml(preview) + '</span>' +
                '<div class="chat-content">' + marked.parse(msg.content || "") + '</div>' +
                '</div>';
        }).join("");
    }

    function extractResponseContent(text) {
        try {
            var parsed = JSON.parse(text);
            if (parsed.choices && parsed.choices[0]) {
                var msg = parsed.choices[0].message;
                if (msg && msg.content) return msg.content;
            }
        } catch (e) {}
        if (text && text.trim() && text[0] !== '{') return text;
        return null;
    }

    function formatParamType(schema) {
        if (!schema) return "";
        if (schema.type === "array" && schema.items) return schema.items.type + "[]";
        if (schema["enum"]) return schema.type + " (" + schema["enum"].join(", ") + ")";
        return schema.type || "";
    }

    function renderToolCard(fn, required) {
        var props = (fn.parameters && fn.parameters.properties) || {};
        var reqSet = new Set(required || (fn.parameters && fn.parameters.required) || []);
        var rows = Object.keys(props).map(function(name) {
            var p = props[name];
            var desc = p.description || "";
            var type = formatParamType(p);
            var req = reqSet.has(name) ? "*" : "";
            return '<tr>' +
                '<td class="tool-param-name">' + escapeHtml(name) + '</td>' +
                '<td class="tool-param-type">' + escapeHtml(type) + '</td>' +
                '<td class="tool-param-desc">' + escapeHtml(desc) + '</td>' +
                '<td class="tool-param-req">' + req + '</td>' +
                '</tr>';
        }).join("");

        var tableHtml = rows
            ? '<table class="tool-params">' +
              '<thead><tr><th>Param</th><th>Type</th><th>Description</th><th>Req</th></tr></thead>' +
              '<tbody>' + rows + '</tbody></table>'
            : '<div style="color:#8b949e;font-size:11px">No parameters</div>';

        return '<div class="tool-card">' +
            '<div class="tool-name">' + escapeHtml(fn.name || "") + '</div>' +
            '<div class="tool-desc">' + escapeHtml(fn.description || "") + '</div>' +
            tableHtml +
            '</div>';
    }

    function renderTools(tools) {
        var names = tools.map(function(t) {
            var fn = t["function"] || t;
            return fn.name || "";
        });
        var summary = '<div class="tools-summary">' +
            '<span class="tools-summary-label">' + tools.length + ' tools:</span>' +
            names.map(function(name, i) {
                return '<span class="tools-summary-name" data-tool-idx="' + i + '">' + escapeHtml(name) + '</span>';
            }).join("") +
            '</div>';
        var cards = tools.map(function(t, i) {
            var fn = t["function"] || t;
            return renderToolCard(fn).replace('class="tool-card"', 'class="tool-card" id="tool-card-' + i + '"');
        }).join("");
        return summary + cards;
    }

    // Reset all special views back to JSON
    function resetViews() {
        requestView = "json";
        modalRequest.style.display = "";
        modalRequestChat.style.display = "none";
        modalRequestChat.innerHTML = "";
        modalRequestTools.style.display = "none";
        modalRequestTools.innerHTML = "";
        btnChatRequest.classList.remove("active");
        btnToolsRequest.classList.remove("active");
        btnCollapseAll.style.display = "none";
        modalResponse.style.display = "";
        panelRequest.style.display = "";
        panelResponse.style.display = "";
        modalBody.style.gridTemplateColumns = "1fr 1fr";
    }

    // Go to full-width mode on request panel, hiding response
    function enterFullWidth() {
        panelResponse.style.display = "none";
        modalBody.style.gridTemplateColumns = "1fr";
    }

    // Restore two-column layout
    function exitFullWidth() {
        panelResponse.style.display = "";
        modalBody.style.gridTemplateColumns = "1fr 1fr";
    }

    function setRequestView(view) {
        // Hide all request sub-views
        modalRequest.style.display = "none";
        modalRequestChat.style.display = "none";
        modalRequestTools.style.display = "none";
        btnChatRequest.classList.remove("active");
        btnToolsRequest.classList.remove("active");
        btnCollapseAll.style.display = "none";

        if (view === requestView) {
            // Toggle off: back to JSON
            modalRequest.style.display = "";
            exitFullWidth();
            requestView = "json";
            return;
        }

        requestView = view;
        if (view === "chat") {
            try {
                var parsed = JSON.parse(rawRequestBody);
                var messages = parsed.messages;
                if (messages && messages.length) {
                    var responseContent = extractResponseContent(rawResponseBody);
                    if (responseContent) {
                        messages = messages.concat([{role: "assistant", content: responseContent}]);
                    }
                    modalRequestChat.innerHTML = renderMessages(messages);
                    modalRequestChat.style.display = "";
                    btnChatRequest.classList.add("active");
                    btnCollapseAll.style.display = "";
                    enterFullWidth();
                    return;
                }
            } catch (e) {}
            // Fallback: stay on JSON
            modalRequest.style.display = "";
            requestView = "json";
        } else if (view === "tools") {
            try {
                var parsed = JSON.parse(rawRequestBody);
                var tools = parsed.tools;
                if (tools && tools.length) {
                    modalRequestTools.innerHTML = renderTools(tools);
                    modalRequestTools.style.display = "flex";
                    btnToolsRequest.classList.add("active");
                    enterFullWidth();
                    return;
                }
            } catch (e) {}
            // Fallback: stay on JSON
            modalRequest.style.display = "";
            requestView = "json";
        }
    }

    function renderRow(s) {
        const path = s.query_string ? s.path + "?" + s.query_string : s.path;
        const codeHtml = s.status_code
            ? `<span class="${statusClass(s.status_code)}">${s.status_code}</span>`
            : "-";
        const streamHtml = s.is_streaming
            ? '<span class="badge badge-streaming">stream</span>'
            : "";
        const tokensHtml = s.total_tokens ? s.total_tokens : "-";
        return `<tr data-id="${s.id}" style="cursor:pointer">
            <td><span class="badge badge-${s.status}">${s.status}</span></td>
            <td>${s.created_at}</td>
            <td><span class="badge badge-method">${s.method}</span></td>
            <td>${escapeHtml(path)}</td>
            <td>${codeHtml}</td>
            <td>${formatDuration(s.duration_ms)}</td>
            <td>${streamHtml}</td>
            <td>${tokensHtml}</td>
            <td><a href="${UI_PREFIX}/sessions/${s.id}" class="btn-detail" title="Detail">&#x2197;</a></td>
        </tr>`;
    }

    function formatTokenTotals(totals) {
        if (!totals || !totals.total_tokens) return "";
        return totals.prompt_tokens.toLocaleString() + " in / " +
            totals.completion_tokens.toLocaleString() + " out / " +
            totals.total_tokens.toLocaleString() + " total";
    }

    async function refresh() {
        try {
            const res = await fetch(UI_PREFIX + "/api/sessions");
            if (!res.ok) return;
            const data = await res.json();
            const sessions = data.sessions;
            countEl.textContent = "Sessions (" + sessions.length + ")";
            tbody.innerHTML = sessions.map(renderRow).join("");
            emptyMsg.style.display = sessions.length ? "none" : "block";
            tokenTotalsEl.textContent = formatTokenTotals(data.totals);
        } catch (e) {}
    }

    // Modal
    function openModal(id) {
        modalTitle.textContent = "Loading...";
        modalRequest.textContent = "";
        modalResponse.textContent = "";
        rawRequestBody = "";
        rawResponseBody = "";
        resetViews();
        overlay.classList.add("active");

        fetch(UI_PREFIX + "/api/sessions/" + id)
            .then(r => r.json())
            .then(data => {
                var label = data.method + " " + data.path +
                    (data.status_code ? " — " + data.status_code : "");
                if (data.usage) {
                    label += "  ·  " + data.usage.prompt_tokens + " in / " +
                        data.usage.completion_tokens + " out / " +
                        data.usage.total_tokens + " total";
                }
                modalTitle.textContent = label;
                rawRequestBody = data.request_body || "";
                rawResponseBody = data.response_body || "";
                modalRequest.textContent = rawRequestBody || "(empty)";
                modalResponse.textContent = rawResponseBody || "(empty)";
            })
            .catch(() => {
                modalTitle.textContent = "Error";
                modalRequest.textContent = "Failed to load session.";
            });
    }

    function closeModal() {
        overlay.classList.remove("active");
    }

    document.getElementById("modal-close").addEventListener("click", closeModal);

    // Toggle buttons
    btnChatRequest.addEventListener("click", function() { setRequestView("chat"); });
    btnToolsRequest.addEventListener("click", function() { setRequestView("tools"); });

    // Tools summary click-to-scroll (event delegation)
    modalRequestTools.addEventListener("click", function(e) {
        var nameEl = e.target.closest(".tools-summary-name");
        if (nameEl) {
            var idx = nameEl.dataset.toolIdx;
            var card = document.getElementById("tool-card-" + idx);
            if (card) card.scrollIntoView({ behavior: "smooth", block: "start" });
        }
    });

    // Chat message collapse toggle (event delegation)
    modalRequestChat.addEventListener("click", function(e) {
        var msg = e.target.closest(".chat-message");
        if (msg) msg.classList.toggle("collapsed");
    });

    // Collapse all button
    btnCollapseAll.addEventListener("click", function() {
        var msgs = modalRequestChat.querySelectorAll(".chat-message");
        var allCollapsed = Array.from(msgs).every(function(m) { return m.classList.contains("collapsed"); });
        msgs.forEach(function(m) {
            if (allCollapsed) {
                m.classList.remove("collapsed");
            } else {
                m.classList.add("collapsed");
            }
        });
        btnCollapseAll.textContent = allCollapsed ? "Collapse all" : "Expand all";
    });

    // Copy buttons
    document.querySelectorAll(".btn-copy[data-target]").forEach(function(btn) {
        btn.addEventListener("click", function() {
            var targetId = btn.dataset.target;
            var pre = document.getElementById(targetId);
            var chat = document.getElementById(targetId + "-chat");
            // Copy from whichever is visible
            var text = (chat && chat.style.display !== "none")
                ? chat.textContent
                : pre.textContent;
            navigator.clipboard.writeText(text).then(function() {
                var orig = btn.textContent;
                btn.textContent = "Copied!";
                setTimeout(function() { btn.textContent = orig; }, 1500);
            });
        });
    });

    tbody.addEventListener("click", function(e) {
        // Don't intercept clicks on links
        if (e.target.closest("a")) return;
        const row = e.target.closest("tr[data-id]");
        if (row) openModal(row.dataset.id);
    });

    setInterval(refresh, 3000);
})();
</script>
{% endblock %}
